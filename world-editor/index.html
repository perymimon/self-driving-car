<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>self driving car - world</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="controls">
    <button id="disposeButton">ğŸ—‘ï¸</button>
    <button id="saveButton">ğŸ’¾</button>
    <label>ğŸ“<input type="file" id="fileInput" accept='.world'> </label>
    <button id="openOSMModal">ğŸŒ</button>
    |
    <form id="graphTools" class="toolbar" style="display:inline-block">
        <label>ğŸŒ<input type="radio" name="graph" value="graph"/></label>
        <label>ğŸ”´<input type="radio" name="graph" value="stop"/></label>
        <label>ğŸš¶<input type="radio" name="graph" value="cross"/></label>
        <label>ğŸš—<input type="radio" name="graph" value="start"/></label>
        <label>ğŸ…¿ï¸<input type="radio" name="graph" value="parking"/></label>
        <label>ğŸš¦<input type="radio" name="graph" value="light"/></label>
        <label>ğŸ¯<input type="radio" name="graph" value="target"/></label>
    </form>

    <label class="toolbar">Generates
        <button id="generateButton">âš’ï¸</button>
        |
        <button id="generateRoads">1. ğŸ—ºï¸ï¸</button>
        <button id="generateBuilding">2.ğŸ¨</button>
        <button id="generateTrees">3.ğŸŒ²</button>
        <button id="generateLanes">4.ğŸ›£ï¸</button>
    </label>


</div>
<div class="canvasContainer">
    <canvas id="editorCanvas"></canvas>
</div>
<!-- The Modal -->
<dialog id="myModal">
    <h2>Open Street Map Input</h2>
    <textarea id="osmInput"></textarea>
    <div class="toolbar">
        <button id="processModalBtn">Process</button>
        <button id="closeModalBtn">Close</button>
    </div>
</dialog>

<script type="module">
    import Graph from './js/math/graph.js'
    import GraphEditor from "./js/editors/graphEditor.js";
    import StopEditor from "./js/editors/stopEditor.js";
    import CrossEditor from "./js/editors/crossEditor.js";
    import ViewPort from "./js/viewport.js";
    import World from "./js/world.js"
    import StartEditor from "./js/editors/startEditor.js";
    import YieldEditor from "./js/editors/yieldEditor.js";
    import ParkingEditor from "./js/editors/parkingEditor.js";
    import TargetEditor from "./js/editors/targetEditor.js";
    import LightEditor from "./js/editors/lightEditor.js";
    import {parseRoads} from "./js/math/osm.js";

    const ctx = editorCanvas.getContext('2d')

    var rect = editorCanvas.parentNode.getBoundingClientRect();
    editorCanvas.width = rect.width;
    editorCanvas.height = rect.height - 31;

    const worldString = localStorage.getItem('world')
    const worldInfo = worldString ? JSON.parse(worldString) : null

    var world = worldInfo ? World.Load(worldInfo) : new World(new Graph())
    var viewPort = null
    var tools = {}

    restart()
    setMode('graph')

    function restart(w = world) {
        viewPort = new ViewPort(editorCanvas, w.zoom, w.offset)
        disableEditors()
        tools = {
            graph: {editor: new GraphEditor(viewPort, w.graph)},
            stop: {editor: new StopEditor(viewPort, w)},
            cross: {editor: new CrossEditor(viewPort, w)},
            start: {editor: new StartEditor(viewPort, w)},
            yield: {editor: new YieldEditor(viewPort, w)},
            parking: {editor: new ParkingEditor(viewPort, w)},
            target: {editor: new TargetEditor(viewPort, w)},
            light: {editor: new LightEditor(viewPort, w)},
        }
    }

    function generate(options) {
        world.generate(options)
        restart(world)
    }

    /*toolbar*/
    document.getElementById('generateButton').onclick = () => generate()
    document.getElementById('generateRoads').onclick = () => generate({all: false, roads: true})
    document.getElementById('generateBuilding').onclick = () => generate({all: false, buildings: true})
    document.getElementById('generateTrees').onclick = () => generate({all: false, trees: true})
    document.getElementById('generateLanes').onclick = () => generate({all: false, lanes: true})

    document.getElementById('disposeButton').onclick = function dispose() {
        world.dispose()
    }
    document.getElementById('saveButton').onclick = function save() {
        world.offset = viewPort.offset
        world.zoom = viewPort.zoom

        let a = document.createElement('a')
        a.setAttribute('href', `data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(world))}`)
        a.setAttribute('download', 'name.world')
        a.click()

        localStorage.setItem('world', JSON.stringify(world))
    }
    document.getElementById('fileInput').addEventListener('change', function load(event) {
            const file = event.target.files[0]
            if (!file) {
                alert('No File selected')
                return
            }
            let reader = new FileReader()
            reader.readAsText(file)
            reader.onload = (evt) => {
                let fileContent = evt.target.result
                let jsonData = JSON.parse(fileContent)

                world = World.Load(jsonData)
                restart(world)
                // localStorage.setItem('world', JSON.stringify(world))
            }
        }
    )
    const modal = document.getElementById('myModal')

    document.getElementById('myModal').addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.close();
        }
    })

    // Get the button that opens the modal
    document.getElementById('openOSMModal').addEventListener('click', () => {
        modal.showModal();
    })

    // Get the button that closes the modal
    document.getElementById('closeModalBtn').addEventListener('click', () => {
        modal.close();
    })
    document.getElementById('processModalBtn').onclick = function parsePsmData() {
        if (osmInput.value == "") return

        let {points, segments} = parseRoads(JSON.parse(osmInput.value))
        world.graph.points = points
        world.graph.segments = segments
        world.generate({buildings: false, trees: false})
        console.log(world.laneGuides)
        modal.close()
    }

    document.getElementById('graphTools').onsubmit = (evt) => evt.preventDefault()
    document.getElementById('graphTools').onchange = function (e) {
        e.preventDefault()
        let formData = new FormData(this);
        let mode = formData.get('graph')
        setMode(mode)
    }


    function setMode(mode) {
        disableEditors()
        tools[mode]?.editor.enable()
        document.querySelector(`input[value="${mode}"]`).checked = true
    }

    function disableEditors() {
        for (let mode in tools) {
            tools[mode].editor.disable()
        }
    }

    animate()

    function animate() {
        viewPort.reset()

        world.draw(ctx, viewPort, {showLane: true})
        // viewPort.drawRenderBox(ctx)
        ctx.globalAlpha = 0.3
        for (let mode in tools) {
            tools[mode].editor.display()
        }
        ctx.globalAlpha = 1
        requestAnimationFrame(animate)
    }

</script>
</body>
</html>